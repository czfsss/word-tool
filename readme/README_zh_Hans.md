## Word 文档处理工具集

一个 Word 文档处理插件集合，专为 Dify 平台设计，提供 PDF 文档转换、智能分块和批注功能。支持中文文档处理，采用本地化处理策略，确保数据安全。

## 🚀 核心功能

### 1. PDF 转 Word 转换器 (pdf_to_word)

- **功能描述**: 将 PDF 文档转换为可编辑的 Word 文档
- **技术实现**: 基于 `pdf2docx` 库，支持复杂布局和格式保持
- **支持格式**: PDF → DOCX
- **自定义功能**: 支持自定义输出文件名

### 2. Word 智能分块器 (word_chunk) ⭐

- **功能描述**: 智能分析 Word 文档结构，按可能的标题进行合理的文档分块，尽量保证文档切分时不会导致同一句话被切割而让模型语义识别不全。注：word 格式需要尽量规范标准，针对合同类、法律类文档效果较好。
- **应用场景**: 文档分析、内容提取、知识管理
- **分块策略**: 基于段落语义和文档结构的智能分块算法
- **数量控制**: 支持自定义分块数量（最多 30 个），由于迭代节点最多只能有 30 个迭代对象，所以设置了 30 最大分块数量。

### 3. Word 文档批注器 (word_comment)

- **功能描述**: 为 Word 文档添加真正的原生批注
- **技术特色**: 使用 `python-docx 1.2.0` 原生批注 API
- **批注功能**: 精确定位文本、保持格式、支持自定义批注者
- **输入方式**: JSON 格式批注数据，灵活配置

## 📊 Word 智能分块算法详解

### 算法概述

Word 智能分块器采用多层次的文档分析策略，结合语义理解和结构识别，实现智能文档分割。该算法特别针对合同类、法律类和制度类文档进行了优化，能够智能识别文档结构并进行合理分块，尽量保证文档切分时不会导致同一句话被切割而让模型语义识别不全。

### 核心算法流程

1. **文档元素提取与预处理**：按照文档原始顺序提取段落和表格内容，保留文档结构信息。
2. **文档类型识别**：识别文档类型（通用、合同、制度），根据不同类型采用特定处理策略。
3. **智能标题识别**：通过样式名称、正则模式匹配、格式特征分析和文档类型特定模式等多维度识别标题。
4. **语义分块处理**：根据标题、表格、长段落、短段落和特殊段落等不同类型采用不同分块策略。
5. **分块数量控制**：当分块数量超过限制时，采用数学分组算法进行智能合并。

### 算法特点

1. **文档类型优化**：针对合同、制度等特定文档类型进行优化，识别文档特有结构。
2. **多维度标题检测**：结合样式名称、正则模式、格式特征和文档类型特定模式进行标题识别。
3. **智能语义分块**：根据文档元素类型采用不同分块策略，保持语义完整性。
4. **表格特殊处理**：确保表格与相关标题在同一分块中，保持上下文关联。
5. **数量精确控制**：采用数学分组算法确保精确的分块数量控制，避免过度分块或分块不足。
6. **层级结构识别**：能够识别文档的层级结构，保持逻辑完整性。

## 📖 使用指南

### PDF 转 Word 转换工具

#### 功能描述

此工具将 PDF 文档转换为 Word 格式，同时尽可能保留原始布局和格式。它利用 pdf2docx 库进行高效转换。

#### 输入参数

- **file_path**（字符串，必需）：要转换的 PDF 文件路径
- **output_path**（字符串，可选）：输出 Word 文件的路径。如果未提供，将生成默认路径

#### 输出参数

- **status**（字符串）：操作状态（"success" 或 "error"）
- **message**（字符串）：关于操作结果的详细信息
- **output_file**（字符串）：生成的 Word 文件路径

### Word 智能分块工具

#### 功能描述

此工具智能地将 Word 文档分割成有意义的块，针对合同、法律和政策文档进行了优化。它识别文档结构，识别标题，并执行语义分块以保持上下文完整性。

#### 输入参数

- **file_path**（字符串，必需）：要分块的 Word 文件路径
- **max_chunk**（整数，可选，默认：30）：要生成的最大分块数量
- **min_length**（整数，可选，默认：1000）：被视为独立分块的最小字符长度
- **chunk_overlap**（整数，可选，默认：200）：相邻分块之间的字符重叠

#### 输出参数

- **status**（字符串）：操作状态（"success" 或 "error"）
- **chunks**（数组）：生成的分块列表
  - **index**（整数）：分块索引
  - **content**（字符串）：分块的文本内容
  - **word_count**（整数）：分块中的字数
- **total_chunks**（整数）：生成的分块总数

### Word 文档批注工具

#### 功能描述

此工具为 Word 文档添加原生批注。它支持为段落和表格中的特定文本段添加批注，具有智能文本匹配功能，即使在找不到精确匹配时也能定位目标文本。

#### 输入参数

- **file_path**（字符串，必需）：要添加批注的 Word 文件路径
- **comments**（数组或对象，必需）：要添加的批注列表，支持两种格式：
  - **格式一（对象数组）**：
    ```json
    [
      {
        "text": "批注内容1",
        "target_text": "目标文本1"
      },
      {
        "text": "批注内容2",
        "target_text": "目标文本2"
      }
    ]
    ```
  - **格式二（对象数组，包含多个键值对）**：
    ```json
    [
      {
        "目标文本1": "批注内容1",
        "目标文本2": "批注内容2"
      },
      {
        "目标文本1": "批注内容1",
        "目标文本2": "批注内容2"
      }
    ]
    ```
  - **text**（字符串，必需）：批注文本内容（格式一）
  - **target_text**（字符串，必需）：文档中要批注的目标文本（格式一）
  - **page**（整数，可选）：应添加批注的页码（用于表格批注）

#### 输出参数

- **status**（字符串）：操作状态（"success" 或 "error"）
- **message**（字符串）：关于操作结果的详细信息
- **output_file**（字符串）：带有批注的生成 Word 文件路径
- **invalid_comments**（数组，可选）：无法添加的批注列表
  - **text**（字符串）：失败的批注文本
  - **target_text**（字符串）：找不到的目标文本
  - **reason**（字符串）：失败原因

## 🔧 技术架构

### 核心技术栈

- **文档处理**: python-docx, pdf2docx
- **插件框架**: dify_plugin
- **日志系统**: 统一日志记录和异常处理
- **文件处理**: 临时文件管理和自动清理

### 安全特性

- **本地处理**: 所有操作在本地环境执行
- **临时文件**: 处理完成后自动清理
- **内存安全**: 及时释放内存资源
- **权限控制**: 最小权限原则

### 性能优化

- **内存管理**: 大文档分片处理
- **算法优化**: 智能分块算法，O(n)复杂度
- **缓存策略**: 临时结果缓存
- **并发处理**: 支持多文档并行处理

## 📊 使用场景

### 1. 知识管理系统

- 文档导入和预处理
- 内容分块和索引建立
- 批注和评论管理

### 2. 内容分析平台

- 大型文档智能分割
- 结构化数据提取
- 语义分析预处理

### 3. 协作办公场景

- 文档格式转换
- 批注和审阅流程
- 版本控制和追踪

### 4. 自动化工作流

- 批量文档处理
- 格式标准化
- 内容质量检查

## 🐛 问题排查

### 常见问题

**1. PDF 转换失败**

```
原因：PDF文件损坏或加密
解决：检查PDF文件完整性，解除密码保护
```

**2. 分块结果不理想**

```
原因：文档结构不规范，本插件的分块本意是为了针对文档格式标准的合同类文件或制度类文件
解决：检查标题格式
```

**3. 批注添加失败**

```
原因：目标文本未找到
解决：确保目标文本在文档中存在且格式匹配
```

## 🚀 更新日志

### v0.0.1 (2025-01-03)

- ✨ 新功能：PDF 转 Word 转换器
- ✨ 新功能：Word 智能分块器
- ✨ 新功能：Word 文档批注器
- 🔧 优化：统一文件处理逻辑
- 🔧 优化：改进错误处理机制
- 📝 文档：完善使用指南和 API 文档

---

**开发者**: czfsss  
**版本**: 0.0.1  
**最后更新**: 2025 年 9 月 3 日
